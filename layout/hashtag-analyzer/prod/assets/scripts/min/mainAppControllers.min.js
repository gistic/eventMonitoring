/* hashtag-analyser - 0.1.0 2015-09-15 */
var EventHandlerController=angular.module("EventHandlerController",["highcharts-ng","iso-3166-country-codes","iso-language-codes","googlechart","bootstrapLightbox","uiGmapgoogle-maps","wu.masonry","angular-images-loaded","angular-jqcloud","angularMoment","infinite-scroll","me-lazyload"]);EventHandlerController.controller("EventMainController",["$rootScope","$scope","$http","$location","$window","$anchorScroll","$state","RequestData","CreateEventSource","$timeout","SweetAlert","SweetAlertFactory","ISO3166","Lightbox","$modal","$sce","$cookies","$cookieStore","languageCode","User","filterHashtags",function(a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v){b.dashboardState=!1,("dashboard.liveStreaming"==g.current.name||"dashboard.media"==g.current.name||"dashboard.map"==g.current.name)&&(b.dashboardState=!0),b.Lightbox=o,b.openLightboxModal=function(a){o.openModal(b.mediaQueue,a)},a.eventID=d.search().uuid,b.isActive=function(a){return a===g.current.name},b.eventsLimitExceeded=!1,b.getEvents=function(){b.eventDataChunk="Trending Events";var a="GET",c="/api/events/runningEvents?authToken="+r.userAuthentication,d="";h.fetchData(a,c,d).then(function(a){b.runningUserEvents=a.data.runningUserEvents;for(var c=0;c<b.runningUserEvents.length;c++){var d=b.runningUserEvents[c].hashtags;b.serverEventHashtag=d.replace(/\[|]/g,""),b.runningUserEvents[c].hashtags=b.serverEventHashtag}3==b.runningUserEvents.length&&(b.eventsLimitExceeded=!0)})},b.dashboardSearch=function(){a.eventHashtag=$("#eventHashtag").val(),eventHashtag=a.eventHashtag;var c=v.preventBadHashtags(eventHashtag);if(c)a.searchError=!0,$(".search-error").text(c);else{for(var d=!1,e=0;e<b.runningUserEvents.length;e++)if(b.runningUserEvents[e].hashtags.toLowerCase()===eventHashtag.toLowerCase()){var d=!0;b.runningEventID=b.runningUserEvents[e].uuid}if(d)g.transitionTo("dashboard.liveStreaming",{uuid:b.runningEventID});else if(b.eventsLimitExceeded){var f="You have reached the max. number of active events .. by starting a new one we will close your first event",h="Yes, stop it!";m.showSweetAlert(f,h)}else{var f="if you start new event, you can come back to current one from the homepage",h="Yes, Start it!";m.showSweetAlert(f,h)}}},b.getViewOptions=function(){var c="GET",d="/api/events/"+a.eventID+"/config",e="";h.fetchData(c,d,e).success(function(a){b.eventHashtag=a.hashtags[0]}).error(function(){console.log("#")})},b.getEventStats=function(){b.eventDataChunk="Event Statistics";var c="GET",d="/api/events/"+a.eventID+"/basicStats",e="";h.fetchData(c,d,e).success(function(a){b.totalMediaCount=a.totalMedia,b.totalUsersCount=a.numberOfUsers,b.totalTweetsCount=a.totalTweets+a.totalRetweets}).error(function(){console.log("#")})},b.intervalFunction=function(){k(function(){b.getEventStats()},18e5)},b.intervalFunction(),b.getWarmupData=function(){b.eventDataChunk="Warm Up Tweets";var c="/api/events/"+a.eventID+"/cachedTweets",d="GET",e="";h.fetchData(d,c,e).success(function(c){for(var d=0;d<c.items.length;d++)b.tweet=JSON.parse(c.items[d]),b.tweetsQueue.push(b.tweet);a.loadingEvent=!1}).error(function(){a.loadingEvent=!1,console.log("#")})},b.initDashboardData=function(){u.setUserAuth(),u.getUserAuth()?(b.getWarmupData(),b.getViewOptions(),b.getEventStats(),u.getUserData(),b.getLanguagesStats(),b.drawlanguagesPieChart(),b.getLocationStats(),b.drawLocationGeoChart(),b.drawLocationPieChart(),b.getTopHashtags(),b.getTopSources(),b.getEvents()):g.transitionTo("home")},b.topTweets=[],b.getTopTweets=function(){b.eventDataChunk="Top Tweets";var c="/api/events/"+a.eventID+"/topTweets?authToken="+r.userAuthentication,d="GET",e="";h.fetchData(d,c,e).success(function(a){b.topTweets=[];for(var c=0;c<a.items.length;c++)b.tweet=JSON.parse(a.items[c]),b.topTweets.push(b.tweet),b.topTweets.sort(function(a,b){return b.score-a.score});b.loading=!1}).error(function(){console.log("#")})},b.showLoadMore=!0,b.showLoadMoreButton=function(){b.showLoadMore=!0,b.loadMoreButton(),b.showTotalTweetsNumber=!0},b.loadMostPopular=function(){b.showLoadMore=!1,b.showTotalTweetsNumber=!1,b.loading=!0,b.getTopTweets()},b.tweetsQueue=[],b.lastNewTweets=[],b.tweetsHistory=[],b.loadTweetsFromHistoryArray=[],b.tweetsQueueLength=0,b.lastNewTweetsLength=0,b.mediaQueue=[],b.lastNewMedia=[],b.topPeople=[],b.tweet={},a.$on("$stateChangeStart",function(a,b,c,d,e){"dashboard.liveStreaming"!=b.name&&"dashboard.media"!=b.name&&"dashboard.map"!=b.name&&j.closeEventSource()}),b.tweetsLocation=[],b.defaultMapOnError={center:{latitude:36.03133178,longitude:16.5234375},zoom:2},navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){b.map={center:{latitude:a.coords.latitude,longitude:a.coords.longitude},zoom:6},b.userPositionMarker={id:0,coords:{latitude:a.coords.latitude,longitude:a.coords.longitude}}},function(){b.map=b.defaultMapOnError}):($(".angular-google-map-container").innerHTML="No Geolocation Support.",b.map=b.defaultMapOnError),b.mapOptions={scrollwheel:!1},b.windowOptions={visible:!1},b.onClick=function(){b.windowOptions.visible=!b.windowOptions.visible},b.closeClick=function(){b.windowOptions.visible=!1},b.startEventSource=function(){b.eventSourceUrl=a.baseUrl+"/api/liveTweets?uuid="+a.eventID;var c=j.createSource(b.eventSourceUrl);c.addEventListener("approved-tweets",function(a){b.eventDataChunk="Live Streaming",b.tweet=JSON.parse(a.data),b.tweetID=b.tweet.id_str,null!=b.tweet.geo_location&&(b.tweetGeoLocation=b.tweet.geo_location,b.tweetGeoLocationLatitude=b.tweet.geo_location.latitude,b.tweetGeoLocationLongitude=b.tweet.geo_location.longitude,b.tweetMarkerID=b.tweetsLocation.length,b.tweetsLocation.push({id:b.tweetMarkerID,latitude:b.tweetGeoLocationLatitude,longitude:b.tweetGeoLocationLongitude,show:!1,tweetText:b.tweet.text,tweetUser:b.tweet.user.screen_name,tweetUserPicture:b.tweet.user.original_profile_image_urlhttps}));var c=!1;if(null!=b.tweet.source){var d=b.tweet.source;b.sourceName=d.substring(d.indexOf(">")+1,d.lastIndexOf("<")),b.sourceName=b.sourceName.substring(b.sourceName.indexOf(">"));for(var e=0;e<b.topSource.length;e++)if(b.topSource[e].code==b.sourceName){b.topSource[e].count++,c=!0,b.topSource.sort(function(a,b){return b.count-a.count}),b.drawTweetsSourcesChart(b.topSource);break}c||(b.topSource.push({code:b.sourceName,count:1}),b.topSource.sort(function(a,b){return b.count-a.count}),b.drawTweetsSourcesChart(b.topSource))}b.languageName=t.getLanguageName(b.tweet.lang);var f=!1;if(void 0!=b.languageName){for(var e=0;e<w.data.length;e++)if(w.data[e][0]==b.languageName){w.data[e][1]++,f=!0;break}f||w.data.push([b.languageName,1])}if(null!=b.tweet.extended_media_entities){var g=b.tweet.extended_media_entities.length;b.tweetText=b.tweet.text,b.userScreenName=b.tweet.user.screen_name,b.userProfileImage=b.tweet.user.original_profile_image_urlhttps,b.tweetCreatedAt=b.tweet.created_at,b.tweetIdStr=b.tweet.id_str;for(var e=0;g>e;e++)if(b.mediaType=b.tweet.extended_media_entities[e].type,b.mediaThumb=b.tweet.extended_media_entities[e].media_urlhttps,"video"==b.mediaType)for(var h=b.tweet.extended_media_entities[e].video_variants.length,i=0;h>i;i++){var j=b.tweet.extended_media_entities[e].video_variants[i].content_type;if("video/mp4"==j){b.videoLink=b.tweet.extended_media_entities[e].video_variants[i].url;var k=!1;for(var l in b.mediaQueue){if(b.videoLink==b.mediaQueue[l].url){k=!0;break}k=!1}k||(b.mediaVideoObject={url:b.videoLink,thumb:b.mediaThumb,type:b.mediaType,caption:b.tweetText,userScreenName:b.userScreenName,userProfileImage:b.userProfileImage,tweetIdStr:b.tweetIdStr,tweetCreatedAt:b.tweetCreatedAt,index:b.mediaQueue.length},b.mediaQueue.push(b.mediaVideoObject),b.totalMediaCount++)}}else{b.tweetMedia=b.tweet.extended_media_entities[e].media_urlhttps;var k=!1;for(var l in b.mediaQueue){if(b.tweetMedia==b.mediaQueue[l].url){k=!0;break}k=!1}k||(b.mediaImageObject={url:b.tweetMedia,thumb:b.mediaThumb,type:b.mediaType,caption:b.tweetText,userScreenName:b.userScreenName,userProfileImage:b.userProfileImage,tweetIdStr:b.tweetIdStr,tweetCreatedAt:b.tweetCreatedAt,index:b.mediaQueue.length},b.mediaQueue.push(b.mediaImageObject),b.totalMediaCount++)}}b.$apply(function(){b.tweetsQueue.length>=25?b.lastNewTweets.push(b.tweet):b.tweetsQueue.unshift(b.tweet)},!1),b.totalTweetsCount++}),c.addEventListener("tweets-over-time",function(a){b.data=JSON.parse(a.data),b.$apply(function(){b.drawChart(b.data)},!1)}),c.addEventListener("top-people",function(a){b.data=JSON.parse(a.data),b.$apply(function(){b.topPeople=b.data.topUsers},!1)}),c.addEventListener("country-update",function(a){b.topCountrey=JSON.parse(a.data),b.countryName=n.getCountryName(b.topCountrey.code),b.countryCount=b.topCountrey.count;var c=!1;b.$apply(function(){if(0!=x.data.length)for(var a=0;a<x.data.length;a++)if(x.data[a][0]==b.countryName){x.data[a][1]=b.countryCount,c=!0;break}c||(x.data.push([b.countryName,b.countryCount]),b.topCountriesLength++)},!1)})},b.startEventSource();var w=[];b.languagesPieChart=w,b.drawlanguagesPieChart=function(){w.type="PieChart",w.data=[["Language","Count"]],w.options={displayExactValues:!0,is3D:!0,chartArea:{left:10,top:0,width:"100%",height:"100%"}}};var x=[];b.locationChart=x,b.drawLocationGeoChart=function(){x.type="GeoChart",x.data=[["Country","Tweet Count: "]],x.options={tooltip:{textStyle:{color:"#191919"},showColorCode:!0},height:250,colorAxis:{colors:["#deebf7","#9ecae1","#3182bd"]},displayMode:"regions"}};var y=[];b.locationPieChart=y,b.drawLocationPieChart=function(){y.type="PieChart",y.data=x.data,y.options={displayExactValues:!0,is3D:!0,chartArea:{left:10,top:0,width:"100%",height:"100%"}}},b.getLocationStats=function(){b.eventDataChunk="Locations & Countries";var c="GET",d="/api/events/"+a.eventID+"/topCountries",e="";h.fetchData(c,d,e).success(function(a){for(var c=0;c<a.items.length;c++)b.countryName=n.getCountryName(a.items[c].code),b.countryCount=a.items[c].count,x.data.push([b.countryName,b.countryCount]);b.topCountriesLength=x.data.length-1}).error(function(){console.log("#")})},b.getLanguagesStats=function(){b.eventDataChunk="Languages";var c="GET",d="/api/events/"+a.eventID+"/topLanguages",e="";h.fetchData(c,d,e).success(function(a){for(var c=0;c<a.items.length;c++)b.languageName=t.getLanguageName(a.items[c].code),b.languageCount=a.items[c].count,"und"!=a.items[c].code&&void 0!=b.languageName&&w.data.push([b.languageName,b.languageCount])}).error(function(){console.log("#")})},b.topHashtags=[],b.tagCloudColors=["rgb(49,130,189)","rgb(20,100,255)","rgb(158,202,225)"],b.getTopHashtags=function(){b.eventDataChunk="Top Related Hashtags";var c="GET",d="/api/events/"+a.eventID+"/topHashtags",e="";h.fetchData(c,d,e).success(function(c){for(var d=0;d<c.items.length;d++)b.hashtagWeight=c.items[d].count,b.hashtagText=c.items[d].code,b.topHashtags.push({text:b.hashtagText,weight:b.hashtagWeight,link:a.twitterBaseUrl+"search?q="+b.hashtagText})}).error(function(){console.log("#")})},b.topSource=[],b.getTopSources=function(){b.eventDataChunk="Tweets Sources";var c="GET",d="/api/events/"+a.eventID+"/topSources",e="";h.fetchData(c,d,e).success(function(a){b.topSource=a.items,b.drawTweetsSourcesChart(b.topSource)}).error(function(){console.log("#")})},b.pagesShown=1,b.pageSize=10,b.tweetsShowned=0,b.tweetsQueueLimit=function(){return b.tweetsShowned=b.pageSize*b.pagesShown,b.pageSize*b.pagesShown},b.loadMoreButton=function(){return b.remainingTweetsCount=b.lastNewTweets.length,b.tweetsShowned=b.pageSize*b.pagesShown,b.showLoadMore&&0!=b.lastNewTweets.length?!0:void 0},b.loadMoreMediaButton=function(){return b.pagesShown<b.mediaQueue.length/b.pageSize},b.loadMoreMedia=function(){b.pagesShown++},b.loadMoreTweets=function(){if(b.lastNewTweets.length<=25)b.tweetsQueue=b.lastNewTweets.concat(b.tweetsQueue),b.pagesShown=b.pagesShown+b.lastNewTweets.length%b.pageSize;else{b.tweetsHistory=b.tweetsHistory.concat(b.tweetsQueue);for(var a=b.tweetsQueue.length,c=0;c<b.lastNewTweets.length;c++)c<b.pageSize?b.tweetsQueue.push(b.lastNewTweets[b.lastNewTweets.length-c-1]):b.tweetsHistory.push(b.lastNewTweets[b.lastNewTweets.length-c-1]);b.tweetsQueue.splice(0,a)}b.lastNewTweets=[],b.remainingTweetsCount=b.tweetsQueueLength-b.pageSize*b.pagesShown},b.loadMoreButtonFromHistory=function(){return b.tweetsHistory.length>0},b.loadMoreTweetsFromHistory=function(){b.loadTweetsFromHistoryArray=[];for(var a=0;a<b.pageSize&&b.tweetsHistory.length>a;a++)b.loadTweetsFromHistoryArray.push(b.tweetsHistory[b.tweetsHistory.length-a-1]);b.tweetsQueue=b.tweetsQueue.concat(b.loadTweetsFromHistoryArray),b.tweetsHistory.splice(b.tweetsHistory.length-b.pageSize,b.pageSize)},b.tweetsSourcesChartConfig={options:{chart:{type:"column",height:250,backgroundColor:"rgba(255, 255, 255, 0.01)"},title:{text:""}}},b.drawTweetsSourcesChart=function(){function a(a){for(i=0;i<b.topSource.length;i++)b.tweetsSourceName=b.topSource[i].code,b.tweetsSourceCount=b.topSource[i].count,b.tweetsSources.push({name:b.tweetsSourceName,y:b.tweetsSourceCount});b.chartSeries=[{name:"Tweets count",data:b.tweetsSources,colorByPoint:!0,showInLegend:!1,id:"tweetsChart",color:"rgb(22, 123, 230)"}],b.tweetsSourcesChartConfig={options:{chart:{type:"column",animation:{duration:1500},height:300,backgroundColor:"rgba(255, 255, 255, 0.01)"}},xAxis:{type:"category",gridLineWidth:1,gridLineColor:"rgb(245, 245, 245)",labels:{enabled:!0,rotation:-45,style:{color:"#d5d5d5",font:"11px Trebuchet MS, Verdana, sans-serif"}}},yAxis:{plotLines:[{value:0,width:0,color:"#ffffff"}],title:{text:""},labels:{enabled:!0,style:{color:"#d5d5d5",font:"10px Trebuchet MS, Verdana, sans-serif"}},tickWidth:0,gridLineWidth:1,gridLineColor:"rgb(245, 245, 245)"},series:b.chartSeries,credits:{enabled:!1},loading:!1,title:{text:""}},b.reflow=function(){b.$broadcast("highchartsng.reflow")}}b.tweetsSources=[],a()},b.chartConfig={options:{chart:{type:"areaspline",height:250,backgroundColor:"rgba(255, 255, 255, 0.01)"},title:{text:""}}},b.tweetsTime=[],b.tweetsCount=[],b.drawChart=function(a){function c(){var a=b.data.length,c=[],d=[];b.totalTweets=0;for(var e=0;a>e;e++){c[e]=b.data[e].tweets_count,b.totalTweets+=b.data[e].tweets_count;var f=new Date(b.data[e].time),g=f.getHours()+":"+f.getMinutes();d[e]=g}b.chartSeries=[{name:"Tweets count",data:c,showInLegend:!1,id:"tweetsChart",color:"rgb(22, 123, 230)"}],b.chartConfig={options:{chart:{type:"areaspline",animation:{duration:1500},height:250,backgroundColor:"rgba(255, 255, 255, 0.01)"},plotOptions:{series:{marker:{enabled:!1},stacking:"",connectNulls:!1},areaspline:{}}},xAxis:{categories:d,gridLineWidth:1,gridLineColor:"rgb(245, 245, 245)",dateTimeLabelFormats:{minute:"%H:%M",hour:"%H:%M"},type:"datetime",lineWidth:1,labels:{enabled:!0,style:{color:"#d5d5d5",font:"11px Trebuchet MS, Verdana, sans-serif"}}},yAxis:{plotLines:[{value:0,width:0,color:"#ffffff"}],title:{text:""},labels:{enabled:!0,style:{color:"#d5d5d5",font:"10px Trebuchet MS, Verdana, sans-serif"}},tickWidth:0,gridLineWidth:1,gridLineColor:"rgb(245, 245, 245)"},series:b.chartSeries,credits:{enabled:!1},loading:!1,title:{text:""}},b.reflow=function(){b.$broadcast("highchartsng.reflow")}}c()},b.logOutUser=function(){u.userSignOut(),g.transitionTo("home")}}]);var StartNewEvent=angular.module("StartNewEvent",["trackHashtagApp.services"]);StartNewEvent.controller("StartNewEventController",["$rootScope","$scope","$state","$cookies","RequestData","User","GetEventsData","SweetAlert","SweetAlertFactory","filterHashtags",function(a,b,c,d,e,f,g,h,i,j){b.initHomepage=function(){f.setUserAuth(),a.logedInUser&&f.getUserData(),b.getEvents()},b.getEvents=function(){var c="GET",f="/api/events/runningEvents?authToken="+d.userAuthentication,g="";e.fetchData(c,f,g).success(function(c){b.runningServerEvents=c.runningServerEvents;for(var d=0;d<b.runningServerEvents.length;d++){var e=b.runningServerEvents[d].hashtags;b.serverEventHashtag=e.replace(/\[|]/g,""),b.runningServerEvents[d].hashtags=b.serverEventHashtag}b.runningUserEvents=c.runningUserEvents;for(var d=0;d<b.runningUserEvents.length;d++){var e=b.runningUserEvents[d].hashtags;b.serverEventHashtag=e.replace(/\[|]/g,""),b.runningUserEvents[d].hashtags=b.serverEventHashtag}3==b.runningUserEvents.length&&(b.eventsLimitExceeded=!0),b.historicUserEvents=c.historicUserEvents;for(var d=0;d<b.historicUserEvents.length;d++){var e=b.historicUserEvents[d].hashtags;null!=e&&(b.serverEventHashtag=e.replace(/\[|]/g,""),b.historicUserEvents[d].hashtags=b.serverEventHashtag)}b.trendingHashtags=c.trendingHashtags;for(var d=0;d<b.trendingHashtags.length;d++){var e=b.trendingHashtags[d];b.trendingEventHashtag=e.replace(/\#/g,""),b.mediaUrl=a.defultImage,b.trendingHashtags[d]=b.trendingEventHashtag}b.homepageEvents=b.runningUserEvents.concat(b.runningServerEvents,b.historicUserEvents,b.trendingHashtags),b.loadingHomepageTrending=!1})},b.twitterLogIn=function(){f.getTwitterAuth(!0)},b.startNewEvent=function(d){a.eventHashtag=d;var e=j.preventBadHashtags(a.eventHashtag);if(e)a.searchError=!0,$(".search-error").text(e);else if(a.loadingSearchButton=!0,a.logedInUser){for(var h=!1,k=0;k<b.runningUserEvents.length;k++)if(b.runningUserEvents[k].hashtags.toLowerCase()===a.eventHashtag.toLowerCase()){var h=!0;b.runningEventID=b.runningUserEvents[k].uuid}if(h)c.transitionTo("dashboard.liveStreaming",{uuid:b.runningEventID});else if(b.eventsLimitExceeded){var l="You have reached the max. number of active events .. by starting a new one we will close your first event",m="Yes, stop it!";i.showSweetAlert(l,m)}else g.startServerEvent(a.eventHashtag)}else f.getTwitterAuth(!1,a.eventHashtag)},b.createEventFromTrending=function(d,e){a.eventHashtag=d,a.inputValue=$("#homepageSearchHashtag").val(),a.inputValue=a.eventHashtag,null!=e?a.logedInUser?(a.eventID=e,c.transitionTo("dashboard.liveStreaming",{uuid:a.eventID})):f.getTwitterAuth(!0):b.startNewEvent(a.eventHashtag)},b.logOutUser=function(){f.userSignOut()}}]);var superAdminController=angular.module("superAdminController",[]);superAdminController.controller("SuperAdminCtrl",["$rootScope","$scope","$http","RequestData",function(a,b,c,d){var e="GET",f="/api/events/superAdmin/",g="";d.fetchData(e,f,g).then(function(a){b.serverEvents=a.data.data,console.log(b.serverEvents)}),b.killEvent=function(a){var b=$(a.currentTarget).parent().parent().attr("id"),c="DELETE",e="/api/events/"+b,f="";d.fetchData(c,e,f).then(function(a){})}}]);